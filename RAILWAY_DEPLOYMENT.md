# 🚂 Railway Production Deployment Guide

## Current Status
✅ **Code is ready for deployment!**
- Repository pushed to GitHub: `jshorwitz/synter`
- Docker configuration: `docker-compose.yml` with PostgreSQL + Redis
- Environment template: `.env.template` with all required variables
- Railway configuration: `railway.toml` ready

## 🚀 Deploy to Railway

### Option 1: Railway Dashboard (Recommended)

1. **Open Railway Dashboard**:
   - Go to: https://railway.app/project/astonishing-reflection
   - You're already logged in as: Joel Horwitz (joel.horwitz@gmail.com)

2. **Connect GitHub Repository**:
   - Click "Deploy from GitHub repo"
   - Select: `jshorwitz/synter`
   - Branch: `main`
   - Root directory: `/` (project root)

3. **Add Required Services**:
   - **PostgreSQL**: Click "Add Service" → "Database" → "PostgreSQL"
   - **Redis**: Click "Add Service" → "Database" → "Redis"
   - **Web Service**: Auto-created from GitHub repo

4. **Configure Environment Variables**:
   ```bash
   # Auto-generated by Railway
   DATABASE_URL=postgresql://... (from PostgreSQL service)
   REDIS_URL=redis://... (from Redis service)
   
   # You need to add these manually:
   POSTGRES_PASSWORD=your_secure_password_here
   JWT_SECRET=your_jwt_secret_32_chars_minimum_here
   SESSION_SECRET=your_session_secret_32_chars_minimum_here
   NEXTAUTH_SECRET=your_nextauth_secret_32_chars_minimum_here
   
   # Google Services (required)
   GOOGLE_ADS_CLIENT_ID=your_google_ads_client_id
   GOOGLE_ADS_CLIENT_SECRET=your_google_ads_client_secret
   GOOGLE_ADS_DEVELOPER_TOKEN=your_google_ads_developer_token
   GOOGLE_ADS_CUSTOMER_ID=your_google_ads_customer_id
   
   # BigQuery (required for analytics)
   BIGQUERY_PROJECT_ID=your_gcp_project_id
   BIGQUERY_DATASET=synter_analytics
   GOOGLE_APPLICATION_CREDENTIALS=/app/service-account.json
   
   # PostHog (required for conversion tracking)
   POSTHOG_API_KEY=phc_your_posthog_api_key
   POSTHOG_HOST=https://us.posthog.com
   
   # Optional but recommended
   OPENAI_API_KEY=sk_your_openai_api_key
   
   # Mock flags for testing
   MOCK_REDDIT=true
   MOCK_TWITTER=true
   MOCK_MICROSOFT=true
   MOCK_LINKEDIN=true
   ```

5. **Deploy**:
   - Railway will automatically build using `Dockerfile`
   - Build command: `docker build`
   - Start command: `pnpm start` (defined in `railway.toml`)

### Option 2: Railway CLI (Alternative)

```bash
# From project directory
railway login  # Already done ✅
railway link   # Link to existing project
railway up     # Deploy current directory
```

## 📊 Expected Services After Deployment

Your Railway project will have:

1. **Web Service** (Main App):
   - **Orchestrator API**: Port 3001
   - **Dashboard**: Port 3000
   - **Health Check**: `/health`
   - **Public URL**: `https://synter-production.up.railway.app`

2. **PostgreSQL Database**:
   - **Purpose**: Auth, agent runs, campaign policies
   - **Auto-connected**: `DATABASE_URL` environment variable

3. **Redis**:
   - **Purpose**: Job queues, caching
   - **Auto-connected**: `REDIS_URL` environment variable

## 🔧 Post-Deployment Setup

### 1. Verify Deployment
```bash
# Check health endpoint
curl https://your-app.railway.app/health

# Expected response:
{
  "status": "healthy",
  "timestamp": "2025-09-26T...",
  "services": {
    "postgres": "connected",
    "redis": "connected",
    "orchestrator": "running"
  }
}
```

### 2. Run Database Migrations
```bash
# In Railway console or locally with production DB
railway run npm run migrate
```

### 3. Test Core Features
- **Dashboard**: https://your-app.railway.app (port 3000)
- **API Docs**: https://your-app.railway.app:3001/docs
- **Agent Status**: https://your-app.railway.app:3001/agents/status

### 4. Configure External Services

**BigQuery Setup**:
1. Create service account in Google Cloud Console
2. Download JSON key file
3. Upload to Railway as `GOOGLE_APPLICATION_CREDENTIALS`
4. Ensure BigQuery API is enabled
5. Create dataset: `synter_analytics`

**PostHog Setup**:
1. Sign up at: https://posthog.com
2. Get project API key (starts with `phc_`)
3. Add to Railway environment variables
4. Test connection: `curl https://your-app.railway.app:3001/posthog/test`

## 🎯 Architecture After Deployment

```
Railway Production Environment:
├── Web Service (synter-app)
│   ├── Orchestrator (Port 3001)
│   └── Dashboard (Port 3000)
├── PostgreSQL Database
│   ├── Users & Auth
│   ├── Agent Runs
│   └── Campaign Policies
├── Redis
│   ├── Job Queues
│   └── Session Storage
└── External Services
    ├── BigQuery (Analytics)
    └── PostHog (Events)
```

## 🔐 Security Checklist

- [ ] Strong `POSTGRES_PASSWORD` (20+ characters)
- [ ] Unique `JWT_SECRET` (32+ characters)
- [ ] Unique `SESSION_SECRET` (32+ characters)
- [ ] Valid Google Cloud service account JSON
- [ ] PostHog API key with correct permissions
- [ ] Railway environment variables properly set
- [ ] Database connection encrypted (Railway default)

## 🚨 Troubleshooting

### Build Issues
```bash
# Check build logs in Railway dashboard
# Common issues:
# - Missing environment variables
# - Docker build failures
# - Package installation errors
```

### Runtime Issues
```bash
# Check application logs
railway logs

# Common issues:
# - Database connection failures
# - Missing API credentials  
# - Port binding errors
```

### Database Issues
```bash
# Connect to production database
railway connect postgres

# Check tables exist
\dt

# Check environment
railway variables
```

## ✅ Success Indicators

When deployment is successful, you should see:

1. **Green deployment status** in Railway dashboard
2. **Health endpoint responding**: https://your-app.railway.app/health
3. **Dashboard accessible**: https://your-app.railway.app
4. **Database connected**: Tables created automatically
5. **No error logs** in Railway logs

---

## 🎉 Ready to Deploy!

All code is prepared and ready for production deployment. The cleaned-up architecture with PostgreSQL + BigQuery + PostHog integration provides a robust foundation for cross-platform ad attribution and analytics.

**Next Step**: Go to https://railway.app/project/astonishing-reflection and click "Deploy from GitHub repo" → `jshorwitz/synter` → `main` branch.
